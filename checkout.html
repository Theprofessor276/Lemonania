<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lemonania - Checkout</title>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lemon&family=Lobster&display=swap" rel="stylesheet">
  <link rel="icon" type="image/svg+xml" href="Lemon.png">
  <style>
    .reward-select {
      margin: 1em 0;
      padding: 0.8em 1em;
      background: #FFFACD;
      border-radius: 0.6em;
      border: 1px solid #ffd54f;
      font-family: 'Lemon', 'Lobster', Arial, sans-serif;
    }
    .reward-option {
      margin-bottom: 0.5em;
      display: block;
    }
    .discount { color: green; }
    .error { color: red; }
    .input-row { margin-top: 20px; }
    input[type="text"] {
      padding: 8px;
      width: 200px;
      font-size: 14px;
    }
    button {
      margin-top: 10px;
      padding: 8px 16px;
      font-size: 16px;
      cursor: pointer;
    }
    .pay-btn {
      background-color: green;
      color: white;
      border: none;
    }
    .cancel-btn {
      background-color: crimson;
      color: white;
      border: none;
      margin-left: 10px;
    }
    #boc { min-height: 80vh; }
  </style>
</head>
<body>
  <div id="boc">
    <header>
      <img src="banner.png" title="Lemonania banner" alt="Lemonania banner" style="width:100%">
    </header>
    <div id="nav"></div>
    <script>
      fetch("nav.html")
        .then(r => r.text())
        .then(html => { document.getElementById("nav").innerHTML = html; });
    </script>
    <main>
      <h2>Review Your Order</h2>
      <div id="cartItems"></div>
      <div id="rewardArea"></div>
      <div class="input-row">
        <label for="coupon">Coupon Code:</label><br>
        <input type="text" id="coupon" placeholder="Enter code...">
        <button onclick="applyCoupon()">Apply Code</button>
        <button class="cancel-btn" onclick="cancelCoupon()">Cancel Coupon</button>
        <div id="discountInfo"></div>
      </div>
      <h3 id="totalDisplay"></h3>
      <button class="pay-btn" onclick="payNow()">Pay Now</button>
    </main>
  </div>
  <script>
    // --- Lemon Points helpers ---
    function getLemonPoints() {
      return Math.max(0, parseInt(localStorage.getItem('lemonPoints') || '0', 10));
    }
    function setLemonPoints(points) {
      localStorage.setItem('lemonPoints', String(Math.max(0, Math.floor(points))));
    }
    function updateLemonPointsDisplay() {
      // Not shown on this page, but present for extensibility.
    }

    // --- Cart helpers ---
    function loadCart() {
      try {
        return JSON.parse(localStorage.getItem('cart')) || {};
      } catch {
        return {};
      }
    }
    function saveCart(cart) {
      localStorage.setItem('cart', JSON.stringify(cart));
    }
    function calcCartSubtotal() {
      const cart = loadCart();
      let total = 0;
      for (const item in cart) {
        const entry = cart[item];
        const quantity = entry.quantity ?? 0;
        const price = entry.price ?? 0;
        total += price * quantity;
      }
      return total;
    }

    // --- Lemonania Reward helpers ---
    function getMyRewards() {
      try {
        return JSON.parse(localStorage.getItem('myRewards')) || [];
      } catch {
        return [];
      }
    }
    function saveMyRewards(rewards) {
      localStorage.setItem('myRewards', JSON.stringify(rewards));
    }
    function removeMyReward(index) {
      const rewards = getMyRewards();
      if (index >= 0 && index < rewards.length) {
        rewards.splice(index, 1);
        saveMyRewards(rewards);
      }
    }

    // --- State for checkout ---
    let appliedRewardIndex = null;
    let appliedReward = null;
    let appliedCouponCode = null;
    let appliedDiscount = 0;
    let appliedMin = 0;

    // --- Render cart ---
    function renderCartCheckout() {
      const cart = loadCart();
      const cartDiv = document.getElementById('cartItems');
      if (!cartDiv) return;
      cartDiv.innerHTML = '';
      let total = 0;
      if (Object.keys(cart).length === 0) {
        cartDiv.innerText = "Your cart is empty.";
        updateTotalDisplay(0);
        return;
      }
      for (const item in cart) {
        const entry = cart[item];
        const quantity = entry.quantity ?? 0;
        const price = entry.price ?? 0;
        const subtotal = price * quantity;
        total += subtotal;
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<span>${item} — $${price.toFixed(2)} × ${quantity} = $${subtotal.toFixed(2)}</span>`;
        cartDiv.appendChild(div);
      }
      updateTotalDisplay(total);
    }

    // --- Render Lemonania rewards to select/use ---
    function renderRewardArea() {
      const area = document.getElementById('rewardArea');
      if (!area) return;
      const rewards = getMyRewards();
      if (!rewards.length) {
        area.innerHTML = `<div class="reward-select"><b>No Lemonania rewards available.</b><br>
          <a href="coupons.html">Redeem Lemon Points for Rewards</a></div>`;
        return;
      }
      let subtotal = calcCartSubtotal();
      let options = rewards.map((r, i) => {
        let disabled = subtotal < r.min ? "disabled" : "";
        let checked = appliedRewardIndex === i ? "checked" : "";
        return `<label class="reward-option">
          <input type="radio" name="reward" value="${i}" ${checked} ${disabled} onchange="selectReward(${i})">
          ${r.label || r.code}: $${r.value} off (min $${r.min}) ${subtotal < r.min ? '<span style="color:#c00;">(need $' + r.min + ' in cart)</span>' : ''}
        </label>`;
      }).join('');
      area.innerHTML = `<div class="reward-select"><b>Use a Lemonania Reward:</b><br>${options}
        <button onclick="removeSelectedReward()" style="margin-top:0.8em;">Remove Reward</button></div>`;
    }

    // --- Handle reward select/deselect ---
    function selectReward(idx) {
      const rewards = getMyRewards();
      let subtotal = calcCartSubtotal();
      if (rewards[idx] && subtotal >= rewards[idx].min) {
        appliedRewardIndex = idx;
        appliedReward = rewards[idx];
        appliedCouponCode = null;
        appliedDiscount = appliedReward.value;
        appliedMin = appliedReward.min;
      } else {
        // Don't apply if not eligible
        appliedRewardIndex = null;
        appliedReward = null;
        appliedDiscount = 0;
        appliedMin = 0;
      }
      renderRewardArea();
      updateTotalDisplay(calcCartSubtotal());
      document.getElementById('discountInfo').innerHTML = '';
      document.getElementById('coupon').value = '';
    }
    function removeSelectedReward() {
      appliedRewardIndex = null;
      appliedReward = null;
      appliedDiscount = 0;
      appliedMin = 0;
      renderRewardArea();
      updateTotalDisplay(calcCartSubtotal());
    }

    // --- Coupon code logic ---
    function applyCoupon() {
      const code = document.getElementById('coupon').value.trim().toUpperCase();
      const subtotal = calcCartSubtotal();
      if (appliedRewardIndex !== null) {
        document.getElementById('discountInfo').innerHTML = '<span class="error">Remove Lemonania reward to use a coupon code.</span>';
        return;
      }
      // Example coupons
      if (code === "SUMMER5" && subtotal >= 25) {
        appliedCouponCode = code;
        appliedDiscount = 5;
        appliedMin = 25;
        document.getElementById('discountInfo').innerHTML = '<span class="discount">SUMMER5 applied: $5 off!</span>';
      } else if (code === "BIGLEMON" && subtotal >= 50) {
        appliedCouponCode = code;
        appliedDiscount = 12;
        appliedMin = 50;
        document.getElementById('discountInfo').innerHTML = '<span class="discount">BIGLEMON applied: $12 off!</span>';
      } else {
        appliedCouponCode = null;
        appliedDiscount = 0;
        appliedMin = 0;
        document.getElementById('discountInfo').innerHTML = '<span class="error">Invalid code or not enough in cart!</span>';
      }
      updateTotalDisplay(subtotal);
    }
    function cancelCoupon() {
      appliedCouponCode = null;
      appliedDiscount = 0;
      appliedMin = 0;
      document.getElementById('coupon').value = '';
      document.getElementById('discountInfo').innerHTML = '';
      updateTotalDisplay(calcCartSubtotal());
    }

    // --- Update displayed total with reward/coupon ---
    function updateTotalDisplay(subtotal) {
      let discount = (typeof appliedDiscount === "number" ? appliedDiscount : 0);
      let min = appliedMin || 0;
      let original = subtotal;
      let info = "";
      let finalTotal = subtotal;
      if (discount > 0 && subtotal >= min) {
        finalTotal = Math.max(0, subtotal - discount);
        info += ` <span class="discount">( -$${discount.toFixed(2)} )</span>`;
      }
      document.getElementById("totalDisplay").innerHTML =
        `Total: $${finalTotal.toFixed(2)}${info}`;
    }

    // --- Pay Now (checkout) ---
    function payNow() {
      const subtotal = calcCartSubtotal();
      // Check for reward
      if (appliedRewardIndex !== null) {
        if (subtotal < (appliedReward?.min || 0)) {
          alert("You do not have enough in your cart for this reward.");
          return;
        }
        // Remove used reward ONLY after successful payment
        removeMyReward(appliedRewardIndex);
        appliedRewardIndex = null;
        appliedReward = null;
      }
      // Award Lemon Points: 1 per $1 spent (before discount)
      const pointsEarned = Math.floor(subtotal);
      // Reset coupon/reward
      appliedCouponCode = null;
      appliedDiscount = 0;
      appliedMin = 0;
      // Clear cart
      localStorage.removeItem('cart');
      alert(`Thank you for your order!\nYou earned ${pointsEarned} Lemon Points! 🍋`);
      window.location.href = "index.html";
    }

    // --- On page load ---
    document.addEventListener("DOMContentLoaded", function() {
      renderCartCheckout();
      renderRewardArea();
    });

    // Expose for inline onchange
    window.selectReward = selectReward;
    window.removeSelectedReward = removeSelectedReward;
  </script>
</body>
</html>